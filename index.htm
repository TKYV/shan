<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vant@2.2/lib/index.css">
    <style>
        .van-checkbox__label {
            width: 100%;
        }
    </style>
</head>

<body>
    <div id="vue">

        <van-search v-model="value" show-action label="地址" placeholder="请输入搜索关键词" @search="onSearch">
            <template #action>
                <div @click="onSearch">搜索</div>
            </template>
        </van-search>

        <van-dropdown-menu>
            <van-dropdown-item v-model="value" :options="option">
            </van-dropdown-item>
            <van-dropdown-item title="筛选" ref="item">
                <van-cell-group>
                    <van-switch-cell v-model="switch1" title="包邮" />
                </van-cell-group>
                <van-cell-group>
                    <van-switch-cell v-model="switch2" title="团购" />
                </van-cell-group>
                <van-button block type="info" @click="onConfirm">确认</van-button>
            </van-dropdown-item>
        </van-dropdown-menu>

        <section>
            <van-card class="s-card">
                <template #tags>
                    <van-image round width="65px" height="65px" fit="cover" lazy-load
                        src="https://img.yzcdn.cn/vant/cat.jpeg" alt="缺省图"></van-image>
                    <p>秋天的风 </p>
                    <p>180****2258</p>
                </template>
            </van-card>
        </section>


        <section>
            <!-- 购物车列表 -->
            <van-checkbox-group v-model="checkedGroup" ref="checkboxGroup">
                <van-card :price="item.price" :desc="item.desc" v-for="(item,index) in shopcard" :key="index">
                    <template slot="title">
                        <!-- 自定义标题部分，主要是为了添加删除商品按钮 -->
                        <span>{{item.title}}</span>
                        <span style="float:right;" @click="removeShop(item)">
                            <van-icon name="delete" />
                        </span>
                    </template>
                    <template slot="thumb">
                        <!-- 自定义左侧部分，为了添加左侧checkbox -->
                        <van-checkbox :name="item.title" checked-color="#b90505" icon-size="12px">
                            <van-image :src="item.thumb"></van-image>
                        </van-checkbox>

                    </template>
                    <template slot="bottom">
                        <!-- 自定义底部，为了实现商品数量功能 -->
                        <div class="num">
                            <van-button size="small" @click="minusnum(item)" :disabled="item.num <=1">-</van-button>
                            <!-- 数量小于1时禁用按钮 -->
                            {{item.num}}
                            <van-button size="small" @click="addnum(item)">+</van-button>
                        </div>
                    </template>
                </van-card>
            </van-checkbox-group>
            <!-- 统计 -->
            <div class="count">
                <van-row style="text-align:center">
                    <van-col span="6">
                        <!-- 全选CheckBox部分 -->
                        <van-checkbox @click="checkAll" v-model="isAllChecked" checked-color="#b90505" icon-size="12px">
                            全选</van-checkbox>
                    </van-col>
                    <van-col span="12" style="font-size:14px">
                        <!-- 总价格部分 -->
                        总计：<span style="font-size:16px;font-weight:700">{{'￥'+allcount}}</span>
                    </van-col>
                    <van-col span="6">
                        <!-- 结算按钮 -->
                        <van-button round color="#b90505">结算</van-button>
                    </van-col>
                </van-row>
            </div>
        </section>

    </div>

</body>
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vant@2.2/lib/vant.min.js"></script>
<script src="https://cdn.bootcss.com/axios/0.19.0-beta.1/axios.min.js"></script>
<script src="https://sucai.suoluomei.cn/sucai_zs/file/20191217145416-area.js"></script>
<script src="https://cdn.bootcss.com/eruda/1.4.3/eruda.min.js"></script>
<!-- 高德地图 -->
<script type="text/javascript"
    src="https://webapi.amap.com/maps?v=1.4.1&key=58b4d21fc077537dda2dcbe756a1c9&plugin=AMap.Geocoder"></script>

<script>
    
    eruda.init();

    Vue.use(vant.Lazyload, {
        lazyComponent: true
    });

    new Vue({
        el: '#vue',
        data() {
            return {
                show: false,
                areaList: are,
                value: 0,
                switch1: false,
                switch2: false,
                option: [
                    { text: '全部商品', value: 0 },
                    { text: '新款商品', value: 1 },
                    { text: '活动商品', value: 2 }
                ], isAllChecked: false, checkedGroup: [], shopcard: [{
                    id: '1',
                    title: '进口香蕉',
                    desc: '约250g，2根',
                    price: 200,
                    num: 1,
                    thumb: 'https://img.yzcdn.cn/public_files/2017/10/24/2f9a36046449dafb8608e99990b3c205.jpeg'
                }, {
                    id: '2',
                    title: '陕西蜜梨',
                    desc: '约600g',
                    price: 690,
                    num: 1,
                    thumb: 'https://img.yzcdn.cn/public_files/2017/10/24/f6aabd6ac5521195e01e8e89ee9fc63f.jpeg'
                }, {
                    id: '3',
                    title: '美国伽力果',
                    desc: '约680g/3个',
                    price: 2680,
                    num: 1,
                    thumb: 'https://img.yzcdn.cn/public_files/2017/10/24/320454216bbe9e25c7651e1fa51b31fd.jpeg'
                }]
                ,
                locationData: {
                    // 用于定位相关信息提交
                    lat: "", // 纬度
                    lon: "", // 经度
                    province: "", // 省
                    city: "", // 市
                    district: "", // 区 县
                    nowPlace: "", // 省-市-区
                    Address: "" // 详细地址
                }
            }
        },
        mounted() {
            var key = '363f73cc6d1cd03f815332fc5ed430e9'
            var address = '河南省商丘市'
            //this.getLocation();
        }, computed: {
            //computed中，判断全选状态
            isAllChecked() {
                console.log(this.checkedGroup.length);
                console.log(this.shopcard.length);
                if (this.checkedGroup.length === this.shopcard.length && this.shopcard.length !== 0) { //选中数与商品总数相等并且购物车内存在商品
                    return true //表示全选状态
                } else {
                    return false //表示未全选
                }
            },//computed中
            allcount() {
                let sumup = 0
                for (let i = 0; i < this.shopcard.length; i++) {
                    if (this.checkedGroup.find(item => { //判断是否选中商品，未选中不计算在内
                        return item === this.shopcard[i].title
                    })) {
                        sumup += this.shopcard[i].num * this.shopcard[i].price
                    } else {
                        continue
                    }
                }
                return sumup
            }
        },
        methods: {
            //地址选择开始
            onSearch() { },
            toSelect() {
                this.show = true;
            },
            confirmFn(value) {
                this.show = false;
                console.log(value)
            },
            cancelFn() {
                this.show = false;
            },
            //地址选择结束
            onConfirm() {
                this.$refs.item.toggle();
            }, formatPrice(price) {
                return (price / 100).toFixed(2);
            }//methods中，点击全选按钮时
            ,
            checkAll() {
                if (this.checkedGroup.length !== 0) { //有商品卡片选中
                    if (this.checkedGroup.length === this.shopcard.length) { //总商品数与选中商品卡片数相等，说明此时已全选
                        this.$refs.checkboxGroup.toggleAll(false); //令所有选中的反选，即全不选
                    } else { //商品卡片数部分选中
                        this.$refs.checkboxGroup.toggleAll(true); //令所有商品全部选中
                    }
                } else { //没有商品卡片选中，直接全选
                    this.$refs.checkboxGroup.toggleAll(true);
                }
            }, addnum(item) {
                this.shopcard.find(element => {
                    return element.title === item.title
                }).num = parseInt(item.num) + 1
            },
            minusnum(item) {
                this.shopcard.find(element => {
                    return element.title === item.title
                }).num = parseInt(item.num) - 1
            },
            //methods中，点击删除商品图标按钮时
            removeShop(item) {
                for (let i = 0; i < this.shopcard.length; i++) {
                    if (item.title === this.shopcard[i].title) {
                        let index = this.checkedGroup.indexOf(item.title)
                        this.shopcard.splice(i, 1) //移除商品
                        if (index === -1) {
                            return
                        }
                        this.checkedGroup.splice(index, 1) //移除checkedGroup中刚刚删除的商品，不然不会即时刷新
                    }
                }
            },// 获取经纬度信息
            getLocation() {

                let that = this
                var map = new AMap.Map('container', {
                    resizeEnable: true
                });
                AMap.plugin('AMap.Geolocation', function () {
                    var geolocation = new AMap.Geolocation({
                        enableHighAccuracy: true,//是否使用高精度定位，默认:true
                        timeout: 10000,          //超过10秒后停止定位，默认：5s
                        buttonPosition: 'RB',    //定位按钮的停靠位置
                        buttonOffset: new AMap.Pixel(10, 20),//定位按钮与设置的停靠位置的偏移量，默认：Pixel(10, 20)
                        zoomToAccuracy: true,   //定位成功后是否自动调整地图视野到定位点

                    });
                    map.addControl(geolocation);
                    geolocation.getCurrentPosition(function (status, result) {
                        if (status == 'complete') {
                            that.onComplete(result)
                        } else {
                            that.onError(result)
                        }
                    });
                });
            } //解析定位结果
            ,
            onComplete(data) {
                // document.getElementById('status').innerHTML='定位成功'
                var str = [];
                str.push('定位结果：' + data.position);
                str.push('定位类别：' + data.location_type);
                if (data.accuracy) {
                    str.push('精度：' + data.accuracy + ' 米');
                }//如为IP精确定位结果则没有精度信息
                str.push('是否经过偏移：' + (data.isConverted ? '是' : '否'));
                console.log(str)
                alert('定位成功' + str)
                // document.getElementById('result').innerHTML = str.join('<br>');
            },
            //解析定位错误信息
            onError(data) {
                console.log('定位失败')
                console.log(data.message)
                alert('定位失败' + data.message)
                // document.getElementById('status').innerHTML='定位失败'
                // document.getElementById('result').innerHTML = '失败原因排查信息:'+data.message;
            },

            getLocation2() {
                const self = this;
                AMap.plugin("AMap.Geolocation", function () {
                    var geolocation = new AMap.Geolocation({
                        enableHighAccuracy: true, // 是否使用高精度定位，默认:true
                        timeout: 10000, // 超过10秒后停止定位，默认：无穷大
                        maximumAge: 0, // 定位结果缓存0毫秒，默认：0
                        convert: true // 自动偏移坐标，偏移后的坐标为高德坐标，默认：true
                    });

                    geolocation.getCurrentPosition();
                    AMap.event.addListener(geolocation, "complete", onComplete);
                    AMap.event.addListener(geolocation, "error", onError);

                    function onComplete(data) {
                        // data是具体的定位信息
                        // debugger
                        console.log("定位成功信息：", data);
                        self.newGetAddress(data.position.lat, data.position.lng);
                    }

                    function onError(data) {
                        // debugger
                        // 定位出错
                        console.log("定位失败错误：", data);
                        self.getLngLatLocation();
                    }
                });
            },
            getLngLatLocation() {
                const self = this;
                AMap.plugin("AMap.CitySearch", function () {
                    var citySearch = new AMap.CitySearch();
                    citySearch.getLocalCity(function (status, result) {
                        if (status === "complete" && result.info === "OK") {
                            // 查询成功，result即为当前所在城市信息
                            console.log("通过ip获取当前城市：", result);
                            //逆向地理编码
                            AMap.plugin("AMap.Geocoder", function () {
                                var geocoder = new AMap.Geocoder({
                                    // city 指定进行编码查询的城市，支持传入城市名、adcode 和 citycode
                                    city: result.adcode
                                });

                                var lnglat = result.rectangle.split(";")[0].split(",");

                                geocoder.getAddress(lnglat, function (status, data) {
                                    if (status === "complete" && data.info === "OK") {
                                        // result为对应的地理位置详细信息
                                        console.log(data);
                                        self.userInfo.ProvinceName = data.regeocode.addressComponent.province.toString();
                                        self.userInfo.CCityName =
                                            data.regeocode.addressComponent.city;
                                        self.userInfo.RegionName =
                                            data.regeocode.addressComponent.district;
                                    }
                                });
                            });
                        }
                    });
                });
            },
            newGetAddress: function (latitude, longitude) {
                const _thisSelf = this;
                _thisSelf.locationData.lat = latitude;
                _thisSelf.locationData.lon = longitude;
                const mapObj = new AMap.Map("mapAmap1");
                mapObj.plugin("AMap.Geocoder", function () {
                    const geocoder = new AMap.Geocoder({
                        city: "全国", // city 指定进行编码查询的城市，支持传入城市名、adcode 和 citycode
                        radius: 100 // 以已知坐标为中心点，radius为半径，返回范围内兴趣点和道路信息
                    });
                    const lnglat = [longitude, latitude]; // 倒序反写经纬度
                    // 天津120 北京110 上海310 重庆500 ,
                    const reg1 = /^[1][1][0][0-9][0-9][0-9]/;
                    const reg2 = /^[1][2][0][0-9][0-9][0-9]/;
                    const reg3 = /^[5][0][0][0-9][0-9][0-9]/;
                    const reg4 = /^[3][1][0][0-9][0-9][0-9]/;
                    geocoder.getAddress(lnglat, function (status, result) {
                        console.log("getAddress", result);
                        if (status === "complete" && result.info === "OK") {
                            // result为对应的地理位置详细信息
                            const adcode = result.regeocode.addressComponent.adcode; // 省市编码
                            if (
                                reg1.test(adcode) ||
                                reg2.test(adcode) ||
                                reg3.test(adcode) ||
                                reg4.test(adcode)
                            ) {
                                _thisSelf.locationData.city =
                                    result.regeocode.addressComponent.province;
                            } else {
                                _thisSelf.locationData.city =
                                    result.regeocode.addressComponent.city;
                            }
                            // 提取 省 市 区 详细地址信息 重拼装省-市-区信息
                            _thisSelf.locationData.province =
                                result.regeocode.addressComponent.province;
                            _thisSelf.locationData.district =
                                result.regeocode.addressComponent.district;
                            _thisSelf.locationData.Address = result.regeocode.formattedAddress;
                            _thisSelf.locationData.nowPlace =
                                result.regeocode.addressComponent.province +
                                result.regeocode.addressComponent.city +
                                result.regeocode.addressComponent.district;
                            _thisSelf.userInfo.ProvinceName = _thisSelf.locationData.province;
                            _thisSelf.userInfo.CCityName = _thisSelf.locationData.city;
                            _thisSelf.userInfo.RegionName = _thisSelf.locationData.district;
                        } else {
                            console.log(_thisSelf.locationData); // 回调函数
                        }
                    });
                });
            }
        },
        created() {
            this.getLocation2();
        }
    });


</script>


</html>
